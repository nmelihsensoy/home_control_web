<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Home Control</title>
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="sidebar col-3">
          <h2 class="logo">HOME CONTROL</h2>
          <div class="nav flex-column nav-pills side-nav" id="v-pills-tab">
            <a class="nav-link active" id="v-pills-home-tab" data-toggle="pill" href="#v-pills-home" role="tab" aria-controls="v-pills-home" aria-expanded="true">Dashboard</a>
            <a class="nav-link" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile" role="tab" aria-controls="v-pills-profile" aria-expanded="true">Tv Remote</a>
            <a class="nav-link" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile" role="tab" aria-controls="v-pills-profile" aria-expanded="true">RFID</a>
            <a class="nav-link" id="v-pills-messages-tab" data-toggle="pill" href="#v-pills-messages" role="tab" aria-controls="v-pills-messages" aria-expanded="true">Devices</a>
          </div>
          <div id="conStatus" class="alert alert-dark" role="alert">
            
          </div>
        </div>
        <div class="main col-8">
          <div class="cardC row">
            <div class="card-side col-3">
              <div class="vAlign">
                <h6>KORİDOR</h6>
                <i class="material-icons icon">home</i>
              </div>
            </div>
            <div class="card-main col-9">
              <div class="weather-main row">
                <div id="weather" class="weather col-6 weather_color">
                  <i class="material-icons iconW">wb_sunny</i>
                  <h3></h3>
                </div>
                <div id="humidity" class="humidity col-6 humidity_color">
                  <i class="material-icons iconW">whatshot</i>
                  <h3></h3>
                </div>
              </div>
            </div>
            </div>
          <div class="cardC row">
            <div class="card-side col-3">
              <div class="vAlign">
                <h6>KAPI</h6>
                <i class="material-icons icon">move_to_inbox</i>
              </div>
            </div>
            <div class="card-main col-9">
              <div id="doorOpen" class="alert alert-danger text-center" role="alert">
                <h3>KAPI AÇIK</h3>
              </div>
              <div id="doorClosed" class="alert alert-info text-center" role="alert">
                <h3>KAPI KAPALI</h3>
              </div>
              <div class="button-group row">
                <div class="buttonWrap col-md-4">
                  <a href="#" class="btn btn-light customButton">
                    <i class="material-icons icon">exit_to_app</i><br/>
                    APT Kapısı Aç
                  </a>
                </div>
                <div class="buttonWrap col-md-4">
                  <a href="#" onclick="doorUnlock()" class="btn btn-light customButton">
                    <i class="material-icons icon">lock_open</i><br/>
                    Kapıyı Aç
                  </a>
                </div>
                <div class="buttonWrap col-md-4">
                  <a href="#" onclick="doorLock()" class="btn btn-light customButton">
                    <i class="material-icons icon">lock_outline</i><br/>
                    Kapıyı Kilitle
                  </a>
                </div>
              </div>
              <div class="alert alert-light" role="alert">
                Okutulan Kart: <span id="rfidTag" class="badge badge-primary"></span>
                <footer class="blockquote-footer rfid-timestamp"><cite id="RfidAgo" title="timestamp" data-rfidtime=""></cite></footer>
              </div>
            </div>
            </div>
            <div class="cardC row">
            <div class="card-side col-3">
              <div class="vAlign">
                <h6>ODA</h6>
                <i class="material-icons icon">airline_seat_individual_suite</i>
              </div>
            </div>
            <div class="card-main col-9">
              <div class="button-group row">
                <div class="buttonWrap col-md-4">
                  <a href="#" onclick="roomLamp()" class="btn btn-light customButton">
                    <i class="material-icons icon">lightbulb_outline</i><br/>
                    Oda Lambası
                  </a>
                </div>
              </div>
            </div>
            </div>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <span class="text-muted">Home Control Web App</span>
        <span class="text-muted float-right">@nmelihsensoy</span>
      </div>
    </footer>
      
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var socket = io.connect('http://melihs.duckdns.org:5000');
        socket.on('connect', function () {
          document.getElementById("conStatus").innerText = 'Socket Connected';
          socket.on('mqtt', function (msg) {
            //console.log(msg.topic + ' /// '+msg.payload)  
                  
            if((msg.topic) && (msg.topic == "/melih/doorState")){
              if(msg.payload == "ON"){
                document.getElementById("doorOpen").style.display = 'block';
                document.getElementById("doorClosed").style.display = 'none';
              }else if(msg.payload == "OFF"){
                document.getElementById("doorOpen").style.display = 'none';
                document.getElementById("doorClosed").style.display = 'block';
              }
            }else if(msg.topic == "/melih/dht"){
              var dht =  msg.payload;
              dht = dht.split('/');

              document.getElementById("weather").getElementsByTagName("h3")[0].innerText = dht[0] + "°C";
              document.getElementById("humidity").getElementsByTagName("h3")[0].innerText = dht[1] + "%";
            }else if(msg.topic == "/melih/rfid"){
              var rfidTime = Date.now();
              document.getElementById("rfidTag").innerText = msg.payload;
              document.getElementById("RfidAgo").setAttribute("data-rfidtime", rfidTime);
              updateTimeStamp();
              setInterval(updateTimeStamp, 5000);
            }
         });
         socket.emit('subscribe', '/melih/doorState');
         socket.emit('subscribe', '/melih/dht');
         socket.emit('subscribe', '/melih/rfid');
        });

        socket.on('disconnect', function() {
          document.getElementById("conStatus").innerText = 'Socket Disconnected';
         });

        function roomLamp(){
          socket.emit('publish',{topic:'/melih/oda/lamp', payload:'ON'});
        }

        function outDoor() {
          socket.emit('publish', {topic:'/melih/outDoor', payload:'ON'});
        }

        function doorUnlock() {
          socket.emit('publish', {topic:'/melih/doorServo', payload:'OP'});
        }

        function doorLock(){
          socket.emit('publish', {topic:'/melih/doorServo', payload:'LO'});
        }

        function updateTimeStamp(){
          var secondBetweenTwoDate = Math.round((new Date().getTime() - document.getElementById("RfidAgo").getAttribute("data-rfidtime")) / 1000);
          document.getElementById("RfidAgo").innerText = secondBetweenTwoDate + " sec ago";
        }
    </script>
  </body>
</html>